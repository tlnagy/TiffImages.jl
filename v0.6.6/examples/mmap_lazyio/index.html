<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Lazy TIFFs · TiffImages.jl</title><meta name="title" content="Lazy TIFFs · TiffImages.jl"/><meta property="og:title" content="Lazy TIFFs · TiffImages.jl"/><meta property="twitter:title" content="Lazy TIFFs · TiffImages.jl"/><meta name="description" content="Documentation for TiffImages.jl."/><meta property="og:description" content="Documentation for TiffImages.jl."/><meta property="twitter:description" content="Documentation for TiffImages.jl."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><script src="https://analytics.tamasnagy.com/js/script.js" data-domain="tamasnagy.com" defer></script><link href="../../democards/gridtheme.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.svg" alt="TiffImages.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">TiffImages.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Examples</span><ul><li><a class="tocitem" href="../reading/">Reading TIFFs</a></li><li><a class="tocitem" href="../writing/">Writing TIFFs</a></li><li class="is-active"><a class="tocitem" href>Lazy TIFFs</a></li></ul></li><li><a class="tocitem" href="../../demos/">Demos</a></li><li><span class="tocitem">Library</span><ul><li><a class="tocitem" href="../../lib/public/">Public</a></li><li><input class="collapse-toggle" id="menuitem-4-2" type="checkbox"/><label class="tocitem" for="menuitem-4-2"><span class="docs-label">Extending</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../lib/extend/">Overview</a></li><li><a class="tocitem" href="../../lib/extend/tags/">Built-in Tags</a></li></ul></li></ul></li><li><a class="tocitem" href="../../contributing/">Contributing</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Examples</a></li><li class="is-active"><a href>Lazy TIFFs</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Lazy TIFFs</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/tlnagy/TiffImages.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/tlnagy/TiffImages.jl/blob/master/examples/mmap_lazyio.jl" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Lazy-TIFFs"><a class="docs-heading-anchor" href="#Lazy-TIFFs">Lazy TIFFs</a><a id="Lazy-TIFFs-1"></a><a class="docs-heading-anchor-permalink" href="#Lazy-TIFFs" title="Permalink"></a></h1><p>If you&#39;re running into memory-limitations when working with large datasets, you can lazy-load or memory-map the file so that it looks and behaves as if it were loaded, but actually loads data only when needed.</p><ul><li><a href="#Lazy-TIFFs">Lazy TIFFs</a></li><li class="no-marker"><ul><li class="no-marker"><ul><li><a href="#Memory-mapping-and-lazy-loading">Memory-mapping and lazy loading</a></li><li class="no-marker"><ul><li><a href="#Lazy-operations">Lazy operations</a></li><li><a href="#Example:-Maximum-intensity-projection">Example: Maximum intensity projection</a></li></ul></li><li><a href="#Caveats-and-important-details">Caveats and important details</a></li><li class="no-marker"><ul><li><a href="#Mechanism,-format-support,-and-performance">Mechanism, format support, and performance</a></li><li><a href="#Assigning-values-and-writing-to-disk">Assigning values and writing to disk</a></li><li><a href="#Behavior-on-Windows">Behavior on Windows</a></li></ul></li><li><a href="#Incremental-writing">Incremental writing</a></li><li class="no-marker"><ul><li><a href="#XL-files">XL files</a></li></ul></li></ul></li></ul></li></ul><h3 id="Memory-mapping-and-lazy-loading"><a class="docs-heading-anchor" href="#Memory-mapping-and-lazy-loading">Memory-mapping and lazy loading</a><a id="Memory-mapping-and-lazy-loading-1"></a><a class="docs-heading-anchor-permalink" href="#Memory-mapping-and-lazy-loading" title="Permalink"></a></h3><p>Loading lazily is very similar to <a href="../reading/#Reading-TIFFs">Reading TIFFs</a>, except with the addition of the <code>mmap=true</code> <em>or</em> <code>lazyio=true</code> flag. The differences between the two will be described in the next section.</p><div class="admonition is-success"><header class="admonition-header">Tip</header><div class="admonition-body"><p>A good general rule is to preferentially use <code>mmap=true</code>. It will generally be faster and, perhaps even more importantly, will have much better worst-case behavior. However, it&#39;s more limited in the types of TIFFs that are supported, e.g. compressed and/or striped TIFFs are not supported. For those files, use <code>lazyio=true</code>, which is more flexible.</p><p>See the <a href="#Caveats-and-important-details">Caveats and important details</a> section for more details.</p></div></div><p>First, let&#39;s look at a demonstration using <code>mri.tif</code> from the <a href="https://github.com/tlnagy/exampletiffs"><code>tlnagy/exampletiffs</code></a> repo.</p><pre><code class="language-julia hljs">using TiffImages
img = TiffImages.load(filepath; lazyio=true);</code></pre><p>Regardless of the size of the file, this is likely to return <code>img</code> almost immediately. The trick is that the data are not actually loaded (yet)– the image data will be loaded on an as-needed basis.</p><p>The lazily-loaded img will behave much the same as a normal eagerly-loaded image:</p><pre><code class="language-julia hljs">size(img)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">(128, 128, 27)</code></pre><p>Display the 2nd slice</p><pre><code class="language-julia hljs">img[:, :, 2]</code></pre><img src="49677c35.png" alt="Example block output"/><h4 id="Lazy-operations"><a class="docs-heading-anchor" href="#Lazy-operations">Lazy operations</a><a id="Lazy-operations-1"></a><a class="docs-heading-anchor-permalink" href="#Lazy-operations" title="Permalink"></a></h4><p>One of the primary benefits of lazy-loading is avoiding unnecessary work for portions of the image that may never be accessed. I recommend using <code>MappedArrays</code> to continue the &quot;laziness&quot; of operations.</p><pre><code class="language-julia hljs">using Colors
using MappedArrays

eltype(img)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">RGB{N0f16}</code></pre><p>We can lazily modify our data for only the slices we end up actually displaying. For example, <code>img</code> is stored as an RGB, despite the fact that you can see it consists only of grayscale intensities. Let&#39;s convert the <code>eltype</code> lazily:</p><pre><code class="language-julia hljs">gray_img = of_eltype(Gray, img);</code></pre><p>Then when we extract a slice from disk, it converts only that one to gray</p><pre><code class="language-julia hljs">slice = gray_img[:, :, 1]</code></pre><img src="data:image/png;base64,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"><p>We can check to make sure its <code>eltype</code> is correct:</p><pre><code class="language-julia hljs">eltype(slice)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Gray{N0f16}</code></pre><h4 id="Example:-Maximum-intensity-projection"><a class="docs-heading-anchor" href="#Example:-Maximum-intensity-projection">Example: Maximum intensity projection</a><a id="Example:-Maximum-intensity-projection-1"></a><a class="docs-heading-anchor-permalink" href="#Example:-Maximum-intensity-projection" title="Permalink"></a></h4><p>It&#39;s pretty straigtforward to do a max-intensity projection:</p><pre><code class="language-julia hljs">dropdims(maximum(gray_img, dims=3), dims=3)</code></pre><img src="data:image/png;base64,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"><p>While this demonstration was performed with <code>lazyio=true</code>, for files that support <code>mmap=true</code> the results would be similar.</p><h3 id="Caveats-and-important-details"><a class="docs-heading-anchor" href="#Caveats-and-important-details">Caveats and important details</a><a id="Caveats-and-important-details-1"></a><a class="docs-heading-anchor-permalink" href="#Caveats-and-important-details" title="Permalink"></a></h3><h4 id="Mechanism,-format-support,-and-performance"><a class="docs-heading-anchor" href="#Mechanism,-format-support,-and-performance">Mechanism, format support, and performance</a><a id="Mechanism,-format-support,-and-performance-1"></a><a class="docs-heading-anchor-permalink" href="#Mechanism,-format-support,-and-performance" title="Permalink"></a></h4><p><code>mmap=true</code> and <code>lazyio=true</code> correspond, internally, to two different strategies for deferring the work of loading, and the differences can be visible to users.</p><ul><li><code>lazyio=true</code> uses an internal single-slice data buffer, and each frame of the TIFF file is read into this buffer on an as-needed basis.</li><li><code>mmap=true</code> uses <a href="https://en.wikipedia.org/wiki/Memory-mapped_I/O">memory-mapped I/O</a> to set up a virtual address space for the entire array, and the operating system&#39;s memory manager takes care of loading chunks of data into physical memory and mapping it to the virtual address space on an as-needed basis.</li></ul><p>The two strategies support different features and exhibit different performance:</p><ul><li><code>mmap=true</code> requires a one-to-one correspondence between what is on disk and what is in memory. Consequently, features like compression are not supported. Currently, there is also no support for files that write slice data in <a href="https://en.wikipedia.org/wiki/TIFF#Overview">strips</a>. Both of these features are supported with <code>lazyio=true</code>.</li><li>with <code>lazyio=true</code>, switching slices is an expensive operation, because an entire new slice has to be read into the buffer; as a consequence, access patterns that stay &quot;within-slice&quot; (like <code>sum(img[:,:,1])</code>) are fast, while access patterns that cross slices (like <code>sum(img[1, 1, :])</code>) are slow; access patterns that alternate between slices (e.g., interpolation across the third dimension) are essentially unusable. <code>mmap=true</code> can be more selective about the data it loads, for example reading subsets of single slices. It can also keep previously-loaded data in memory even as you switch slice planes, so that reloads are less common. Consequently, when supported, <code>mmap=true</code> achieves good performance more consistently.</li></ul><h4 id="Assigning-values-and-writing-to-disk"><a class="docs-heading-anchor" href="#Assigning-values-and-writing-to-disk">Assigning values and writing to disk</a><a id="Assigning-values-and-writing-to-disk-1"></a><a class="docs-heading-anchor-permalink" href="#Assigning-values-and-writing-to-disk" title="Permalink"></a></h4><p>Aside from generality and performance, there are other important differences. Currently, <code>lazyio=true</code> does not support assigning new values to the array: <code>img[:, :, 2] .= 0.0</code> throws an error. <code>mmap=true</code> can support setting values, but <em>setting values also writes those same values to the disk file</em>. To guard against unintended data corruption, by default <code>load(filepath; mmap=true)</code> opens the file with read-only permission, and then assigning values throws an error. Using <code>flagler.tif</code> from the <a href="https://github.com/tlnagy/exampletiffs"><code>tlnagy/exampletiffs</code></a> repo (a file which is of a format that can be read with <code>mmap=true</code>), we get</p><pre><code class="language-julia hljs">img = TiffImages.load(filepath_flagler, mmap=true)</code></pre><img src="cda5ed83.png" alt="Example block output"/><p>but</p><pre><code class="language-julia hljs">julia&gt; img[1,1,1] = RGB(1, 0, 0)
ERROR: ReadOnlyMemoryError()</code></pre><p>To support writing, open the file with read/write permissions:</p><pre><code class="language-julia hljs">img = TiffImages.load(filepath_flagler, mode=&quot;r+&quot;, mmap=true);</code></pre><p>Then, assignment will work and <em>the same value will be written to the disk file</em>.</p><div class="admonition is-warning"><header class="admonition-header">Warning</header><div class="admonition-body"><p>Casual use of <code>mode=&quot;r+&quot;</code> can lead to data corruption, so use it only when you intend to rewrite data.</p></div></div><h4 id="Behavior-on-Windows"><a class="docs-heading-anchor" href="#Behavior-on-Windows">Behavior on Windows</a><a id="Behavior-on-Windows-1"></a><a class="docs-heading-anchor-permalink" href="#Behavior-on-Windows" title="Permalink"></a></h4><p>On Microsoft Windows, one additional caveat is that deleting or replacing a file that has been <code>mmap</code>ed by your Julia process will result in either a <code>IOError: unlink(&lt;file path&gt;): permission denied (EACCES)</code> or <code>LoadError: SystemError: opening file &lt;file path&gt;: Invalid argument</code> error. If you&#39;re done using the image, you may want to ensure it is garbage-collected first:</p><pre><code class="language-julia hljs">img = nothing
GC.gc()</code></pre><p>If successful, this will terminate the <code>mmap</code> and the file can be deleted without causing an error in the Julia session. However, any reference to <code>img</code> by any other object can prevent garbage collection; one safe pattern is</p><pre><code class="language-julia hljs">let img = TiffImages.load(filepath; mmap=true)
    # operations on `img` go here
end
GC.gc()</code></pre><p>Such tricks are not generally necessary on other platforms, which handle deletion by unlinking the file from its name but otherwise keep the data on disk if it is being <code>mmap</code>ped by one or more processes. After all such processes have exited, the actual data are deleted by the operating system.</p><h3 id="Incremental-writing"><a class="docs-heading-anchor" href="#Incremental-writing">Incremental writing</a><a id="Incremental-writing-1"></a><a class="docs-heading-anchor-permalink" href="#Incremental-writing" title="Permalink"></a></h3><p><code>TiffImages</code> also supports writing to a file via an append operation. We have a special type for this called <a href="../../lib/public/#TiffImages.LazyBufferedTIFF"><code>LazyBufferedTIFF</code></a>, that we can create via the standard <code>empty</code> function</p><pre><code class="language-julia hljs">using ImageCore # reexports Gray and N0f8
img2 = empty(LazyBufferedTIFF, Gray{N0f8}, &quot;test.tif&quot;)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi"><span class="sgr36">32-bit</span> LazyBufferedTIFF{Gray{N0f8}} <span class="sgr1">0×0×0</span><span class="sgr32"> (writable)</span>
    Current file size on disk:   8 bytes
    Addressable space remaining: 4.000 GiB
</code></pre><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>For data-integrity reasons, <code>TiffImages</code> will not allow you to append to an pre-existing file and will throw an error if a file exists at the filepath that you provide.</p></div></div><p>Say you have the following data:</p><pre><code class="language-julia hljs">slice = rand(Gray{N0f8}, 256, 256)</code></pre><img src="fc45da96.png" alt="Example block output"/><p>You can then push new data to the <code>img2</code> object and it will eagerly write that data to disk.</p><pre><code class="language-julia hljs">push!(img2, slice)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi"><span class="sgr36">32-bit</span> LazyBufferedTIFF{Gray{N0f8}} <span class="sgr1">256×256×1</span><span class="sgr32"> (writable)</span>
    Current file size on disk:   64.151 KiB
    Addressable space remaining: 4.000 GiB
</code></pre><p>The first slice sets the XY dimensions of the TIFF and subsequent slices must have the same dimensions as the first.</p><pre><code class="language-julia hljs">push!(img2, rand(Gray{N0f8}, 256, 256))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi"><span class="sgr36">32-bit</span> LazyBufferedTIFF{Gray{N0f8}} <span class="sgr1">256×256×2</span><span class="sgr32"> (writable)</span>
    Current file size on disk:   128.295 KiB
    Addressable space remaining: 4.000 GiB
</code></pre><p>The memory-mapped object also behaves like an array and supports most array operations (other than inplace mutating ones like <code>setindex!</code>)</p><pre><code class="language-julia hljs">size(img2)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">(256, 256, 2)</code></pre><p>To read a slice that you just wrote:</p><pre><code class="language-julia hljs">img2[:, :, 2]</code></pre><img src="930303e9.png" alt="Example block output"/><h4 id="XL-files"><a class="docs-heading-anchor" href="#XL-files">XL files</a><a id="XL-files-1"></a><a class="docs-heading-anchor-permalink" href="#XL-files" title="Permalink"></a></h4><p>If you&#39;re going to be writing lots of data to disk (4GB+) then it can be helpful to set the <code>bigtiff</code> flag to true so that <code>TiffImages</code> can use 64-bit offsets. You&#39;ll see that the addressable space sky rockets:</p><pre><code class="language-julia hljs">img3 = empty(LazyBufferedTIFF, Gray{N0f16}, &quot;test.btif&quot;; bigtiff=true)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi"><span class="sgr36">64-bit</span> LazyBufferedTIFF{Gray{N0f16}} <span class="sgr1">0×0×0</span><span class="sgr32"> (writable)</span>
    Current file size on disk:   16 bytes
    Addressable space remaining: 16384.000 PiB
</code></pre><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../writing/">« Writing TIFFs</a><a class="docs-footer-nextpage" href="../../demos/">Demos »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="auto">Automatic (OS)</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.0.1 on <span class="colophon-date" title="Friday 22 September 2023 01:53">Friday 22 September 2023</span>. Using Julia version 1.9.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
